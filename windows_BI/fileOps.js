/*
++++++++++++++Windows Apps Files Operations Monitoring+++++++++
CreateFile, ReadFile, WriteFile, CloseHandle
*/

const CreateFileA = Module.getExportByName('kernelbase.dll', 'CreateFileA');
const CreateFileW = Module.getExportByName('kernelbase.dll', 'CreateFileW');
/*
HANDLE CreateFileA(
  [in]           LPCSTR                lpFileName,
  [in]           DWORD                 dwDesiredAccess,
  [in]           DWORD                 dwShareMode,
  [in, optional] LPSECURITY_ATTRIBUTES lpSecurityAttributes,
  [in]           DWORD                 dwCreationDisposition,
  [in]           DWORD                 dwFlagsAndAttributes,
  [in, optional] HANDLE                hTemplateFile
);
*/
Interceptor.attach(CreateFileA, {
    onEnter: function(args){
        console.log("Buffer dump:\n" + hexdump(args[1]));
    }
});
const WriteFile = Module.getExportByName('kernelbase.dll', 'WriteFile');
/*
BOOL WriteFile(
  [in]                HANDLE       hFile,
  [in]                LPCVOID      lpBuffer,
  [in]                DWORD        nNumberOfBytesToWrite,
  [out, optional]     LPDWORD      lpNumberOfBytesWritten,
  [in, out, optional] LPOVERLAPPED lpOverlapped
);
*/
Interceptor.attach(WriteFile, {
    onEnter: function(args){
        console.log("Buffer dump:\n" + hexdump(args[1]));
        // console.log("\nBuffer via Cstring:\n" + Memory.readCString(args[1]));
        // console.log("\nBuffer via utf8String:\n" + Memory.readUtf8String(args[1]));
    }
});

const CloseHandle = Module.getExportByName(null, "CloseHandle");
Interceptor.attach(CloseHandle, {
    onEnter: function(args){
        console.log("Buffer dump:\n" + hexdump(args[1]));
        // console.log("\nBuffer via Cstring:\n" + Memory.readCString(args[1]));
        // console.log("\nBuffer via utf8String:\n" + Memory.readUtf8String(args[1]));
    }
});